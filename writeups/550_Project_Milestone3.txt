******************************
QUERIES/DESCRIPTIONS
******************************

1. Beginning with a simple query, let's get a list of players that were active as of 2022 (ordered by last name, first name):

SELECT *
FROM Players
WHERE LastPlayed = 2022
ORDER BY SUBSTRING_INDEX(Name, ' ', -1), SUBSTRING_INDEX(Name, ' ', 1);

That's nearly 1,500 players! Some great, some ... well, the minor leagues exist for a reason.


2. For the 2022 season, let's get some simple (position) player statistics. Players that played on multiple teams in 2022 (e.g., players that were traded midseason) will have multiple associated records. To make it interesting, let's make it so that the players with the most home runs in 2022 appear at the top of the leaderboard:

SELECT p.Name, t.Name, bs.G AS Games, bs.AB AS `At Bats`, (bs.1B + bs.2B + bs.3B + bs.HR) AS Hits, bs.HR AS `Home Runs`
FROM Players AS p
JOIN BattingStats AS bs
ON p.ID = bs.PlayerID
JOIN Teams AS t
ON bs.Team = t.ID
WHERE Season = 2022
ORDER BY `Home Runs` DESC;

There's the new American League single-season home run record holder Aaron Judge at the top! I wonder where he'll sign this offseason?


3. Let's perform a similar exercie for pitchers; we can sort them by strikeouts:

SELECT p.Name, t.Name, ps.G AS Games, ps.IP AS `Innings Pitched`, ps.ER AS `Earned Runs`, ROUND(9 * ps.ER / ps.IP, 2) AS `Earned Run Average`, ps.K AS Strikeouts, ps.BB AS Walks
FROM Players AS p
JOIN PitchingStats AS ps
ON p.ID = ps.PlayerID
JOIN Teams AS t
ON ps.Team = t.ID
WHERE Season = 2022
ORDER BY Strikeouts DESC;

Gerrit Cole actually set the Yankees single-season strikeout record last season ... not that that stopped Yankees fans from booing him.


4. What if we want to know about a batter's performance during the entirety of the Statcast era? Let's find their wRC+ (a rate statistic that measures hitting---think of it as a more advanced version of batting average) and wins above replacement (WAR, a cumulative statistic---think of this as the number of additional games the team would have lost without said player) between 2015 and 2022 inclusive:

SELECT p.Name, ROUND(bs.`wRC+`) AS `Weighted Runs Created Plus`, bs.WAR AS `Wins Above Replacement`
FROM Players AS p
JOIN (SELECT PlayerID, SUM(`wRC+` * PA) / SUM(PA) AS `wRC+`, SUM(WAR) AS WAR
      FROM BattingStats
      GROUP BY PlayerID) AS bs
ON p.ID = bs.PlayerID
ORDER BY `Wins Above Replacement` DESC;

I hear that Mike Trout guy is pretty good.


5. Advanced statistics are fun! Another one that captures pitching ability is fielding independent pitching (FIP), which is better than earned run average (ERA) because it is calculated using only strikeouts, walks, and home runs allowed. So if a pitcher plays for a team with a terrible defense, he may allow more earned runs than are deserved:

SELECT p.Name, ROUND(ps.ERA, 2) AS `Earned Run Average`, ROUND(ps.FIP, 2) AS `Fielding Independent Pitching`, ps.WAR AS `Wins Above Replacement`
FROM Players AS p
JOIN (SELECT PlayerID, SUM(ERA * TBF) / SUM(TBF) AS ERA, SUM(FIP * TBF) / SUM(TBF) AS FIP, SUM(WAR) AS WAR
      FROM PitchingStats
      GROUP BY PlayerID) AS ps
ON p.ID = ps.PlayerID
ORDER BY `Wins Above Replacement` DESC;

There is a stronger correlatioin between FIP and WAR than between ERA and WAR. If Aaron Nola played for a team that could actually field (cough cough Rhys Hoskins cough cough), his ERA would have been a third of a run lower and he may have actually won the Cy Young award. Oh well.


6. Statcast tracks pitched and batted balls with quarter-inch precision, which means that we tell how hard a ball was thrown, its spin rate in (RPMs), its release location, where it crossed home plate, how hard it was hit ... the possibilities are endless! Let's test this out by selecting the pitchers that have thrown the most tracked pitches:

SELECT p.Name, ps.Pitches
FROM (SELECT PitcherID, COUNT(*) AS Pitches
      From PitchStats
      GROUP BY PitcherID) AS ps
JOIN Players AS p
ON ps.PitcherID = p.ID
ORDER BY Pitches DESC;

That's a lot of pitches, man. My arm is tired just reading that leaderboard.


******************************
COMPLEX QUERIES/DESCRIPTIONS
******************************

7. Let's get some more information about pitches. What Phillies pitcher had the best curveball in 2022? What was its spin rate?

SELECT p.Name, ps.wCU, pi.SpinRate AS `Spin Rate`
FROM Players AS p
JOIN (SELECT PlayerID, wCU
      FROM PitchingStats
      WHERE SEASON = 2022 AND `CU%` IS NOT NULL AND
            Team = (SELECT ID
                    FROM Teams
                    WHERE Name = 'Philadelphia Phillies')) AS ps
ON p.ID = ps.PlayerID
JOIN (SELECT PitcherID, AVG(SpinRate) AS SpinRate
      FROM PitchStats
      WHERE Season = 2022 AND
            PitcherTeam = (SELECT ID
                           FROM Teams
                           WHERE Name = 'Philadelphia Phillies') AND
            PitchType = (SELECT ID
                         FROM Pitches
                         WHERE Name = 'Curveball')
      GROUP BY PitcherID) AS pi
ON p.ID = pi.PitcherID
ORDER BY ps.wCU DESC, `Spin Rate` DESC;

Zach Eflin sure can bend it like Beckham! This query works by 






2. Find the proportion of pitches that a particular pitcher ('First Last') throws in each zone. 

WITH tmp(Zone, pitch_count)
    AS (SELECT Zone, COUNT(pitch_id)
        FROM Pitches
        WHERE player_ID = (SELECT PlayerID
                           FROM Players
                           WHERE Name = 'First Last')
        GROUP BY zone)
SELECT Zone, pitch_count / SUM(pitch_count) as zone_proportion
FROM tmp
ORDER BY pitch_count / SUM(pitch_count)



2. Find all of the pitch types that a particular pitcher ('First Last') throws and their proportions
   in the 2022 season. 

WITH tmp(Type, pitch_count)
    AS (SELECT Type, COUNT(pitch_id)
        FROM Pitches
        WHERE player_ID = (SELECT PlayerID
                           FROM Players
                           WHERE Name = 'First Last')
              AND Season = '2022'
        GROUP BY Type)
SELECT Type, pitch_count / SUM(pitch_count) as pitch_type_proportion
FROM tmp
ORDER BY pitch_count / SUM(pitch_count)



3. Compare a particular team's pitchers based on their earned run average (ERA).

SELECT p.Name, p2.EarnedRunAverage
FROM Players p JOIN Pitchers p2 ON p.PlayerID = p2.playerID
WHERE pi.Team = 'PHI'
ORDER BY p2.EarnedRunAverage DESC








******************************
* DATABASE CREDENTIALS
******************************

username: 
host:
port:
password:






